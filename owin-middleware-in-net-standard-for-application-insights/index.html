<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Owin middleware in .NET Standard for Application Insights" /><meta property="og:locale" content="en" /><meta name="description" content="I’m sure that you heard about .NET Standard. To simplify the definition just one quote from the offical GitHub repo FAQ" /><meta property="og:description" content="I’m sure that you heard about .NET Standard. To simplify the definition just one quote from the offical GitHub repo FAQ" /><link rel="canonical" href="/owin-middleware-in-net-standard-for-application-insights/" /><meta property="og:url" content="/owin-middleware-in-net-standard-for-application-insights/" /><meta property="og:site_name" content="Reset your code" /><meta property="og:image" content="/content/images/2017/05/StockSnap_Z6NQG48GT0.jpg" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2017-05-22T20:16:01+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="/content/images/2017/05/StockSnap_Z6NQG48GT0.jpg" /><meta property="twitter:title" content="Owin middleware in .NET Standard for Application Insights" /><meta name="twitter:site" content="@ptrstpp950" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2017-05-22T20:16:01+00:00","datePublished":"2017-05-22T20:16:01+00:00","description":"I’m sure that you heard about .NET Standard. To simplify the definition just one quote from the offical GitHub repo FAQ","headline":"Owin middleware in .NET Standard for Application Insights","image":"/content/images/2017/05/StockSnap_Z6NQG48GT0.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"/owin-middleware-in-net-standard-for-application-insights/"},"url":"/owin-middleware-in-net-standard-for-application-insights/"}</script><title>Owin middleware in .NET Standard for Application Insights | Reset your code</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Reset your code"><meta name="application-name" content="Reset your code"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://pl.gravatar.com/userimage/48672464/c50835d7095c6bf97f05a434fa54cfca.jpg?size=256" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Reset your code</a></div><div class="site-subtitle font-italic">Stapp space :)</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/ptrstpp950" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://www.linkedin.com/in/piotrstapp" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://twitter.com/ptrstpp950" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Owin middleware in .NET Standard for Application Insights</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Owin middleware in .NET Standard for Application Insights</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1495484161" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 22, 2017 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/ptrstpp950">Piotr Stapp</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1327 words"> <em>7 min</em> read</span></div></div></div><div class="post-content"><p>I’m sure that you heard about .NET Standard. To simplify the definition just one quote from <a href="https://github.com/dotnet/standard/blob/master/docs/faq.md">the offical GitHub repo FAQ</a></p><blockquote><p>.NET Standard is a specification that represents a set of APIs that all .NET platforms have to implement. This unifies the .NET platforms and prevents future fragmentation.</p></blockquote><p>BTW in case you don’t know just read the full article <a href="https://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/">Introducing .NET Standard</a>.</p><p>On the other hand, Owin is (from <a href="http://owin.org/">owin.org</a>):</p><blockquote><p>OWIN defines a standard interface between .NET web servers and web applications. The goal of the OWIN interface is to decouple server and application, encourage the development of simple modules for .NET web development, and, by being an open standard, stimulate the open source ecosystem of .NET web development tools.</p></blockquote><p>Both tools should work together in a perfect way. In my case, I tried to find a way to use Application Insights in the OWIN based applications. I have some in .NET Framework and in .NET Core.</p><h2 id="application-insights-owin-extensions"><span class="mr-2">Application Insights OWIN extensions</span><a href="#application-insights-owin-extensions" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There is an open source project <a href="https://github.com/marcinbudny/applicationinsights-owinextensions">Application Insights OWIN extensions</a>. Sounds perfect, isn’t it? But unfortunately, it isn’t. As we check it on <a href="https://icanhasdot.net/result?github=marcinbudny~2Fapplicationinsights-owinextensions">I can have .NET Core</a>, it has some problems. Mostly, because of its reference to <code class="language-plaintext highlighter-rouge">Microsoft.Owin</code> package. There is a known replacement for .NET Core called <code class="language-plaintext highlighter-rouge">Microsoft.AspNetCore.Owin</code>.</p><h2 id="migration"><span class="mr-2">Migration</span><a href="#migration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I migrated a class to uses the <code class="language-plaintext highlighter-rouge">Microsoft.AspNetCore.Owin</code> package:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>public class RequestTrackingMiddleware
{
    private readonly RequestDelegate _next;

    public RequestTrackingMiddleware(RequestDelegate next)
    {
        _next = next;
    }

    public async Task Invoke(HttpContext context)
    {
        var sw = Stopwatch.StartNew();
        await _next(context);
        sw.Stop();
        Console.WriteLine(sw);
    }
</pre></table></code></div></div><p>But this approach is stupid. It is because I cannot use above class in standard .NET Framework. I ended with a question on <a href="http://stackoverflow.com/questions/44051965/creating-owin-middleware-in-net-standard/44065720">Stack Overflow</a>. In the middle my colleague <a href="https://orientman.wordpress.com/">Marcin</a> send me an article about <a href="http://benfoster.io/blog/how-to-write-owin-middleware-in-5-different-steps">How to write OWIN middleware in 5 different steps</a>. It is exactly the same as David Fowl posted in the answer. The third step solves my problem. To simplify the answer we just need to know that all Owin wrappers are made on the top of <code class="language-plaintext highlighter-rouge">IDictionary&lt;string, object&gt; environment</code> class. And <code class="language-plaintext highlighter-rouge">Invoke</code> method must return the <code class="language-plaintext highlighter-rouge">Task</code>. Are you ready? Check the next paragraph for the working code.</p><h2 id="creating-portable-code"><span class="mr-2">Creating portable code</span><a href="#creating-portable-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The first working example which I created is very simple.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>using AppFunc = Func&lt;IDictionary&lt;string, object&gt;, Task&gt;;

public class OwinMiddleware
{
    private readonly AppFunc _next;
    public OwinMiddleware(AppFunc next)
    {
        _next = next;
    }
    public async Task Invoke(IDictionary&lt;string, object&gt; environment)
    {
        var sw = Stopwatch.StartNew();
        await _next.Invoke(environment);
        sw.Stop();
    }
    
}
</pre></table></code></div></div><p>But such code isn’t easy to use because you need to know how to access specific key on the dictionary. To find out what are correct keys probably the easiest way is to use the debugger like below. The wrappers are better, because they give us access using know properties like <code class="language-plaintext highlighter-rouge">Request or </code>Response`</p><p><img data-src="/content/images/2017/05/owin-debugger.png" alt="Owin debugger" data-proofer-ignore></p><h2 id="owin-wrapper"><span class="mr-2">Owin wrapper</span><a href="#owin-wrapper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>So we need an Owin wrapper, without dependencies. And there is exactly such. It is a <a href="https://raw.githubusercontent.com/damianh/LibOwin">LibOwin</a>. But installing using the newest NuGet won’t work. The package will be installed, but there won’t be a file <code class="language-plaintext highlighter-rouge">App_Packages\LibOwin.X.Y\LibOwin.cs</code> as it should. This bug probably is caused by newest NuGet. Anyway, I decided to add manually from the <a href="https://github.com/damianh/LibOwin/blob/master/src/LibOwin/LibOwin.cs">official repo</a>. Hurray, now we have an IntelliSense.</p><p><img data-src="/content/images/2017/05/libowin-intellisense.png" alt="IntelliSense" data-proofer-ignore></p><p>But life is life and there are two compile errors. One is easy to fix just install <code class="language-plaintext highlighter-rouge">System.Security.Claims</code> NuGet package. For the second one, we need a deeper search. The answer is <code class="language-plaintext highlighter-rouge">System.Globalization.Extensions</code> package.</p><p>Above changes allow creating a quite simple method.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>public async Task Invoke(IDictionary&lt;string, object&gt; environment)
{
    var context = new OwinContext(environment);
    await _next.Invoke(environment);
    _log.Info("Resonse staus is: "+context.Response.StatusCode);
</pre></table></code></div></div><p>But how to pass <code class="language-plaintext highlighter-rouge">_log</code> variable? It is not very compilcated.</p><h2 id="additional-arguments"><span class="mr-2">Additional arguments</span><a href="#additional-arguments" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Because I would like to track all requests and send them Application Insights I created following constructor</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>public HttpRequestTelemetryTrackingMiddleware(
            AppFunc next, 
            TelemetryConfiguration configuration = null)
{
   _next = next;
   _client = configuration != null ? new TelemetryClient(configuration) : new TelemetryClient();

}
</pre></table></code></div></div><p>And use it like below in classic .NET Framework</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>public override void Configuration(Owin.IAppBuilder app)
{
  app.Use&lt;HttpRequestTelemetryTrackingMiddleware&gt;();
}
</pre></table></code></div></div><p>Unfortunatley, without a reason, this cause an error: <code class="language-plaintext highlighter-rouge">The class 'HttpRequestTelemetryTrackingMiddleware' does not have a constructor taking 1 arguments</code>. I spent some time why this error happens, but I still don’t know the reason. If you do, please leave a comment or send me an info. Anyway, I added the second constructor to save my time. After above changes and adding a <code class="language-plaintext highlighter-rouge">Microsoft.ApplicationInsights</code> package, the <code class="language-plaintext highlighter-rouge">Invoke</code> function is:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>public async Task Invoke(IDictionary&lt;string, object&gt; environment)
{
    var context = new OwinContext(environment);
    var requestStart = DateTimeOffset.Now;
    
    var sw = Stopwatch.StartNew();
    try
    {
        await _next.Invoke(environment);
        sw.Stop();
    
        var path = context.Request.Path.HasValue ? context.Request.Path.Value : "unknown";
    
        var requestTelemetry = new RequestTelemetry(
            context.Request.Method + " " + path, requestStart, sw.Elapsed,
            context.Response.StatusCode.ToString(), _isRequestSuccessfulFunc(environment));
    
        _client.TrackRequest(requestTelemetry);
    }
    catch (Exception exception)
    {
        _client.TrackException(exception);
        sw.Stop();
    }
}
</pre></table></code></div></div><p>If you decide to copy&amp;paste above code, you will notice that it won’t compile, because <code class="language-plaintext highlighter-rouge">_isRequestSuccessfulFunc</code> is missing. The main aime of it is to detect that request is correct.</p><h2 id="when-http-request-is-a-correct-one"><span class="mr-2">When HTTP request is a correct one?</span><a href="#when-http-request-is-a-correct-one" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A simple answer is when its value is 200. But that’s not true. For example, there are more statuses in the range between 200 and 300, like <code class="language-plaintext highlighter-rouge">204 No Content</code>. They are correct too. The next try is all statuses lower than 400, should be good. But this is untrue too. For example, we don’t want to have temporary redirects (status <code class="language-plaintext highlighter-rouge">302</code>) but status <code class="language-plaintext highlighter-rouge">304 Not Modified</code> is perfect, cause it indicates that the resource has not been modified and the client can use his local cache. Moreover, you want to accept even some <code class="language-plaintext highlighter-rouge">404 Not Found</code> statuses for some requests. For example, in my case, my deployment script makes a fake request to make sure that my 404 page is working correctly. So the final answer is: it is complicated. To make a decision we need more information and it depends on your current project. If you need to check HTTP response statuses, you can check <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes">List of HTTP status codes</a> But the default function can be very simple. I just need to have a control on it. Below the default implementation in the constructor. Notice that I introduced one more parameter.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>public HttpRequestTelemetryTrackingMiddleware(
    AppFunc next,
    Func&lt;IDictionary&lt;string, object&gt;, bool&gt; isSuccessRequestFunc = null,
    TelemetryConfiguration configuration = null)
    
{
    _next = next;
    _isRequestSuccessfulFunc = isSuccessRequestFunc ??
                               (owinCtx =&gt; new OwinContext(owinCtx).Response.StatusCode &lt; 400);

    _client = configuration != null ? new TelemetryClient(configuration) : new TelemetryClient()
}
</pre></table></code></div></div><p>This extension is as much flexible as it is possible, but it will be difficult to use. Because in each implementation we will be missing Owin context helpers. To make it simpler we can make <code class="language-plaintext highlighter-rouge">OwinContext</code> from <code class="language-plaintext highlighter-rouge">LibOwin</code> public and pass it as an argument instead of <code class="language-plaintext highlighter-rouge">IDictionary</code>. To use it we need to define compilation constant LIBOWIN_PUBLIC in the build tag of our project.</p><p><img data-src="/content/images/2017/05/lin_owin_constant.png" alt="" data-proofer-ignore></p><p>After above the constructor simplifies a bit.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre>public HttpRequestTelemetryTrackingMiddleware(
    AppFunc next,
    Func&lt;IOwinContext, bool&gt; isSuccessRequestFunc = null,
    TelemetryConfiguration configuration = null)
{
    _next = next;
    _isRequestSuccessfulFunc = isSuccessRequestFunc ??
                               (owinCtx =&gt; owinCtx.Response.StatusCode &lt; 400)
    _client = configuration != null ? new TelemetryClient(configuration) : new TelemetryClient()
}
</pre></table></code></div></div><h2 id="whats-coming-next"><span class="mr-2">What’s coming next?</span><a href="#whats-coming-next" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Above code only measure a time of HTTP requests, but I need more. I would like to have control on user id, operation id and maybe a session id. Next time I will share my progress how we can track more. So are you ready for the part 2? It is already available: <a href="https://stapp.space/owin-middleware-in-net-standard-for-application-insights-part-2/">Owin middleware in .NET Standard for Application Insights part 2</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/dotnet/" class="post-tag no-text-decoration" >dotnet</a> <a href="/tags/azure/" class="post-tag no-text-decoration" >azure</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Owin+middleware+in+.NET+Standard+for+Application+Insights+-+Reset+your+code&url=%2Fowin-middleware-in-net-standard-for-application-insights%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Owin+middleware+in+.NET+Standard+for+Application+Insights+-+Reset+your+code&u=%2Fowin-middleware-in-net-standard-for-application-insights%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=%2Fowin-middleware-in-net-standard-for-application-insights%2F&text=Owin+middleware+in+.NET+Standard+for+Application+Insights+-+Reset+your+code" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/ACA-missing-yaml/">Exploring Azure Container Apps (ACA) and the Missing YAML Functionality</a><li><a href="/geting-secrets-from-github-actions/">6 steps to pimp my terminal</a><li><a href="/speaking/">Speaking</a><li><a href="/project-json-made-my-life-easier-and-it-is-not-a-joke/">Project.json made my life easier and it is not a joke</a><li><a href="/piotr-stapp-in-2016/">Piotr Stapp in 2016</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/code/">code</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/visual-studio/">visual-studio</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/speaker/">speaker</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/restart-start-and-stop-all-azure-web-apps-in-resource-group-using-powershell/"><div class="card-body"> <em class="small" data-ts="1553009419" data-df="ll" > Mar 19, 2019 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Restart, start and stop all Azure Web Apps in resource group using PowerShell</h3><div class="text-muted small"><p> This post is short but useful. We need just two lines (we can combine it to one): 1 2 $allSites = Get-AzureRmWebApp -ResourceGroupName resource-group-name @($allSites).GetEnumerator() | Restart-Azu...</p></div></div></a></div><div class="card"> <a href="/setup-vagrant-with-azure/"><div class="card-body"> <em class="small" data-ts="1446034351" data-df="ll" > Oct 28, 2015 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Setup vagrant with Azure - step by step guide</h3><div class="text-muted small"><p> Setup Vagrant with Azure is not complicated, but require a lot of steps, especially if you never configure azure using command line Prerequisites First of all we need some tools: Vagrant (https...</p></div></div></a></div><div class="card"> <a href="/floating-versions-in-nuget-2/"><div class="card-body"> <em class="small" data-ts="1450442065" data-df="ll" > Dec 18, 2015 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Floating versions in Nuget</h3><div class="text-muted small"><p> Asp.NET 5 RC At least ASP.NET 5 is production ready. I know that current state is release candidate, but be honest it means that it is ready. Maybe some quick fixes will be need but who cares ;) ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/chrome-coverage/" class="btn btn-outline-primary" prompt="Older"><p>Search and clean redundant JS and CSS on your page</p></a> <a href="/owin-middleware-in-net-standard-for-application-insights-part-2/" class="btn btn-outline-primary" prompt="Newer"><p>Owin middleware in .NET Standard for Application Insights - part 2</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/ptrstpp950">Piotr Stapp</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/code/">code</a> <a class="post-tag" href="/tags/azure/">azure</a> <a class="post-tag" href="/tags/visual-studio/">visual-studio</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/devops/">devops</a> <a class="post-tag" href="/tags/dotnet/">dotnet</a> <a class="post-tag" href="/tags/speaker/">speaker</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/c/">c</a> <a class="post-tag" href="/tags/powershell/">powershell</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-53928517-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-53928517-1'); }); </script>
